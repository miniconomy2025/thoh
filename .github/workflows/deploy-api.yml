name: Deploy Express App to EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Create run.sh
        run: |
          cat <<'EOF' > run.sh
          #!/bin/bash
          set -e

          APP_DIR="/home/${{ vars.EC2_USER }}/thoh"
          SERVICE_NAME="thoh"
          ENTRY_FILE="dist/main.ts"

          echo "--- Installing Node.js ---"
          curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
          sudo yum install -y nodejs

          echo "--- Installing PM2 ---"
          sudo npm install -g pm2

          echo "--- Installing and building frontend ---"
          cd $APP_DIR/frontend
          npm install
          npm run build
          npm run dev

          echo "--- Installing backend dependencies ---"
          cd $APP_DIR/api
          npm install --production
          npm run start

          echo "--- Writing .env ---"
          cat <<ENVEOF > "$APP_DIR/api/.env"
          POSTGRES_HOST=${{ vars.POSTGRES_HOST }}
          POSTGRES_PORT=${{ vars.POSTGRES_PORT }}
          POSTGRES_DB=${{ vars.POSTGRES_DB }}
          POSTGRES_USER=${{ vars.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          MACHINE_FAILURE_URLS=${{ secrets.MACHINE_FAILURE_URLS }}
          TRUCK_FAILURE_URLS=${{ secrets.TRUCK_FAILURE_URLS }}
          BANK_RATE_UPDATE_URL=${{ secrets.BANK_RATE_UPDATE_URL }}
          EPOCH_NOTIFICATION_URLS=${{ secrets.EPOCH_NOTIFICATION_URLS }}
          RETAIL_BANK_API_URL=${{ secrets.RETAIL_BANK_API_URL }}
          PEAR_PHONE_API_URL=${{ secrets.PEAR_PHONE_API_URL }}
          SUM_SANG_API_URL=${{ secrets.SUM_SANG_API_URL }}
          RECYCLER_API_URL=${{ secrets.RECYCLER_API_URL }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_SQS_CRITICAL_QUEUE_URL=${{ secrets.AWS_SQS_CRITICAL_QUEUE_URL }}
          AWS_SQS_BUSINESS_QUEUE_URL=${{ secrets.AWS_SQS_BUSINESS_QUEUE_URL }}
          AWS_SQS_NOTIFICATION_QUEUE_URL=${{ secrets.AWS_SQS_NOTIFICATION_QUEUE_URL }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          END_SIMULATION_URLS=${{ secrets.END_SIMULATION_URLS }}
          COMMERCIAL_BANK_ACCOUNTS_URL=${{ secrets.COMMERCIAL_BANK_ACCOUNTS_URL }}
          APPLICATION_NAME=${{ vars.APPLICATION_NAME }}
          REST_BASE_PATH=${{ vars.REST_BASE_PATH }}
          NODE_ENV=${{ vars.NODE_ENV }}
          COMMERCIAL_BANK_URL=${{ vars.COMMERCIAL_BANK_URL }}
          API_BASEURL=https://${{ vars.EC2_HOST }}${{ vars.REST_BASE_PATH }}
          BULK_LOGISTICS_API_URL=${{ vars.BULK_LOGISTICS_API_URL}}
          CONSUMER_LOGISTICS_API_URL=${{ vars.CONSUMER_LOGISTICS_API_URL }}
          POSTGRES_CA=${{ vars.POSTGRES_CA }}
          POSTGRES_KEY=${{ vars.POSTGRES_KEY }}
          POSTGRES_CERT=${{ vars.POSTGRES_CERT }}
          VITE_API_URL=${{ vars.VITE_API_URL }}
          VITE_COMMERCIAL_BANK_URL=${{ vars.VITE_COMMERCIAL_BANK_URL }}
          ENVEOF
          
          echo "--- Copying .env to frontend ---"
          cat "$APP_DIR/api/.env" > "$APP_DIR/frontend/.env"

          echo "--- Creating systemd service ---"
          sudo tee /etc/systemd/system/$SERVICE_NAME.service > /dev/null <<SERVICEEOF
          [Unit]
          Description=thoh Express App
          After=network.target

          [Service]
          EnvironmentFile=$APP_DIR/api/.env
          WorkingDirectory=$APP_DIR/api
          ExecStart=/usr/bin/node $APP_DIR/api/$ENTRY_FILE
          Restart=always
          User=${{ vars.EC2_USER }}
          Group=${{ vars.EC2_USER }}

          [Install]
          WantedBy=multi-user.target
          SERVICEEOF

          echo "--- Reloading and starting backend service ---"
          sudo systemctl daemon-reload
          sudo systemctl enable $SERVICE_NAME
          sudo systemctl restart $SERVICE_NAME

          echo "--- Installing and configuring NGINX ---"
          sudo yum install -y nginx openssl
          sudo systemctl enable nginx

          CERT_DIR="/etc/nginx/ssl"
          sudo mkdir -p $CERT_DIR

          sudo openssl req -x509 -nodes -days 365 \
            -newkey rsa:2048 \
            -keyout $CERT_DIR/selfsigned.key \
            -out $CERT_DIR/selfsigned.crt \
            -subj "/C=US/ST=Test/L=Test/O=Test/OU=Test/CN=${{ vars.EC2_HOST }}"

          NGINX_CONF="/etc/nginx/conf.d/thoh.conf"

          sudo tee $NGINX_CONF > /dev/null <<NGINXEOF
          server {
              listen 80;
              server_name _;

              location / {
                  return 301 https://\$host\$request_uri;
              }
          }

          server {
              listen 443 ssl;
              server_name _;

              ssl_certificate     $CERT_DIR/selfsigned.crt;
              ssl_certificate_key $CERT_DIR/selfsigned.key;

              ssl_protocols       TLSv1.2 TLSv1.3;
              ssl_ciphers         HIGH:!aNULL:!MD5;

              location / {
                  proxy_pass http://localhost:4173;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection upgrade;
                  proxy_set_header Host \$host;
                  proxy_cache_bypass \$http_upgrade;
              }

              location /api/ {
                  proxy_pass http://localhost:3000/;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection upgrade;
                  proxy_set_header Host \$host;
                  proxy_cache_bypass \$http_upgrade;
              }
          }
          NGINXEOF

          echo "--- Restarting NGINX ---"
          sudo nginx -t && sudo systemctl restart nginx

          echo "âœ… Deployment complete."
          EOF

      - name: Upload files and execute on EC2
        run: |
          scp -o StrictHostKeyChecking=no -i "~/.ssh/id_rsa" run.sh ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/run.sh
          scp -r -o StrictHostKeyChecking=no -i "~/.ssh/id_rsa" api frontend ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }}:/home/${{ vars.EC2_USER }}/thoh
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=60 \
              -o ServerAliveCountMax=30 \
              -i "~/.ssh/id_rsa" \
              ${{ vars.EC2_USER }}@${{ vars.EC2_HOST }} "chmod +x ~/run.sh && nohup ~/run.sh > ~/deploy.log 2>&1 &"